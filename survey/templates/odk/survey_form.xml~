{% load template_tags %}
<h:html xmlns="http://www.w3.org/2002/xforms"
xmlns:h="http://www.w3.org/1999/xhtml"
xmlns:ev="http://www.w3.org/2001/xml-events"
xmlns:xsd="http://www.w3.org/2001/XMLSchema"
xmlns:jr="http://openrosa.org/javarosa">
<h:head>
<h:title> 
  {{survey.name}} 
  {% if survey.has_sampling %} for
  {{ survey.sample_size }} random households only
  {% endif %} 
</h:title>
  <model>
  <instance>
   <survey id="{{ survey.pk }}" >
     <meta>
       <instanceID/>
     </meta>
    <chooseExistingHousehold>0</chooseExistingHousehold>
    {% if registered_households.count > 0 %}
    <registeredHousehold>
        <household />
        <householdMember>
        {% for r_household in registered_households %}
            <h{{r_household.pk}} />
        {% endfor %}
        </householdMember>
    </registeredHousehold>
    {% endif %}
    <household>
        <houseNumber />
		<householdMember>
            <surname />
            <firstName />
            <sex />
            <dateOfBirth />
            <isHead>0</isHead>
            <occupation />
            <levelOfEducation />
            <residentSince />
        </householdMember>
    </household>
	{% for batch in survey_batches %}
		<b{{batch.pk}}>
			{% for question in batch.all_questions %}
				<q{{question.pk}} />
                {% if question.group.name == 'NON_RESPONSE' %}
                 <qnr{{question.pk}} />
                {% endif %}
			{% endfor %}
		</b{{batch.pk}}>
	{% endfor %}
   </survey>
  </instance>

  <!-- bindings -->
  <bind nodeset="/survey/meta/instanceID" type="string" 
           readonly="true()" calculate="concat('uuid:',uuid())" />
   {% if registered_households.count > 0 %}
		<bind nodeset="/survey/chooseExistingHousehold" type="select1"  required="true()" />
	   <bind nodeset="/survey/registeredHousehold/household" type="select1"  required="true()" relevant="selected(/survey/chooseExistingHousehold,'1')" />
	   {% for r_household in registered_households %}
	   <bind nodeset="/survey/registeredHousehold/householdMember/h{{r_household.pk}}" type="select1"  required="true()" relevant="selected(/survey/registeredHousehold/household,'{{r_household.pk}}')" />
	   {% endfor %}
  {% endif %}
  <bind nodeset="/survey/household/houseNumber" type="int"  required="true()" relevant="selected(/survey/chooseExistingHousehold,'0')" />
  <bind nodeset="/survey/household/householdMember/surname" type="string"  required="true()" relevant="selected(/survey/chooseExistingHousehold,'0')" />
  <bind nodeset="/survey/household/householdMember/firstName" type="string"  required="true()" relevant="selected(/survey/chooseExistingHousehold,'0')" />
  <bind nodeset="/survey/household/householdMember/sex" type="select1"  required="true()" relevant="selected(/survey/chooseExistingHousehold,'0')" />
  <bind nodeset="/survey/household/householdMember/dateOfBirth" type="date" required="true()" relevant="selected(/survey/chooseExistingHousehold,'0')"/>
  <bind nodeset="/survey/household/householdMember/isHead" type="select1" required="true()" relevant="selected(/survey/chooseExistingHousehold,'0')" />
  <bind nodeset="/survey/household/householdMember/occupation" type="string" relevant="selected(/survey/household/householdMember/isHead,'1')" />
  <bind nodeset="/survey/household/householdMember/levelOfEducation" type="select1" relevant="selected(/survey/household/householdMember/isHead,'1')" />
  <bind nodeset="/survey/household/householdMember/residentSince" type="date" relevant="selected(/survey/household/householdMember/isHead,'1')" />


	{% for batch in survey_batches  %}
		{% for question in batch.all_questions %}
        {% clean_odk_relevant_context question batch investigator as relevance_context %}
		<bind nodeset="/survey/b{{batch.pk}}/q{{question.pk}}" 
			type="{% if question.answer_type == 'number' %}int{% elif question.answer_type == 'multichoice' %}select1{% elif question.answer_type == 'multiselect' %}select{% elif question.answer_type == 'date' %}date{% elif question.answer_type == 'audio' or question.answer_type == 'image' or question.answer_type == 'video' %}binary{% elif question.answer_type == 'geopoint' %}geopoint{% else %}string{% endif %}" {% if question.answer_type != 'geopoint' and question.group.name != 'NON_RESPONSE' %}required="true()"{% endif %} relevant="true(){% if question.group.name == 'GENERAL' %} and selected(/survey/household/householdMember/isHead,'1'){% endif %}{{ relevance_context }}"/>
        {% is_relevant_odk question batch investigator as relevance_context %}        
           {% if question.group.name == 'NON_RESPONSE' %}
             <bind nodeset="/survey/b{{batch.pk}}/qnr{{question.pk}}" type="string" relevant="string-length(/survey/b{{batch.pk}}/q{{question.pk}})=0" />
           {% endif %}
		{% endfor %}
        
	{% endfor %}

  </model>
</h:head>
<h:body>
    <group>
        <label>Household details</label>
        {% if survey.has_sampling %}
            <hint>Please complete this survey for {{ survey.sample_size }} random households only</hint>
        {% endif %}
        {% if registered_households.count > 0 %}
		    <select1 ref="/survey/chooseExistingHousehold">
					<label>What do you want to do?</label>
					<item>
						<label>Select member from existing household</label>
						<value>1</value>
					</item>
					<item>
						<label>Register new household member</label>
						<value>0</value>
					</item>
				</select1>
		    <select1 ref="/survey/registeredHousehold/household">
		         <label>Select Household</label>
		         {% for r_household in registered_households %}
				    <item>
		               <label>{{r_household.uid}}, {{r_household.get_head.surname}} </label>
		               <value>{{r_household.pk}}</value>
		            </item>                 
		         {% endfor %}
		    </select1>
		    {% for r_household in registered_households %}
		        {% if r_household.all_members %}
		        <select1 ref="/survey/registeredHousehold/householdMember/h{{r_household.pk}}">
		            <label>Select Household Member</label>
				    {% for member in r_household.all_members %}
				    <item>
		               <label>{{member.surname}}, {{member.first_name}} </label>
		               <value>{{member.pk}}</value>
		            </item>
				    {% endfor %}
		        </select1>
		        {% endif %}
		   {% endfor %}
       {% endif %}
		<input ref="/survey/household/houseNumber">
			<label>Enter household number</label>
		</input>
    <group>
        <label>Household Member Details</label>

        	<select1 ref="/survey/household/householdMember/isHead">
				<label>Is this the main respondent of this household?</label>
                <hint>Skip if already assigned for this household</hint>
				<item>
					<label> Yes </label>
					<value>1</value>
				</item>
				<item>
					<label> No </label>
					<value>0</value>
				</item>
			</select1>
		<input ref="/survey/household/householdMember/surname">
						<label>Enter Surname</label>
					</input>
		<input ref="/survey/household/householdMember/firstName">
						<label>Enter Firstname</label>
					</input>
        	<select1 ref="/survey/household/householdMember/sex">
				<label>Enter sex</label>
				<item>
					<label> Male </label>
					<value>1</value>
				</item>
				<item>
					<label> Female </label>
					<value>0</value>
				</item>
			</select1>
        <input ref="/survey/household/householdMember/dateOfBirth">
						<label>Choose Date of Birth</label>
					</input>
        <input ref="/survey/household/householdMember/occupation">
						<label>Enter Occupation</label>
					</input>
        <input ref="/survey/household/householdMember/residentSince">
						<label>Choose date of residency</label>
					</input>
		<select1 ref="/survey/household/householdMember/levelOfEducation">
			<label>Level Of Education</label>
			{% for e_level in educational_levels %}
			<item>
				<label>{{ e_level.1 }}</label>
				<value>{{ e_level.0 }}</value>
			</item>
			{% endfor %}
		</select1>
		</group>            
    </group>
	{% for batch in survey_batches %}
		<group>
			<label>{{ batch.name }}</label>
			<hint>{{ batch.description }}</hint>
			{% for question in batch.all_questions %}
				{% if question.answer_type == 'multichoice' %}
					<select1 ref="/survey/b{{batch.pk}}/q{{question.pk}}">
						<label>{{question.text}}</label>
						{% for option in question.options.all %}
						<item>
							<label>{{ option.text }}</label>
							<value>{{ option.pk }}</value>
						</item>
						{% endfor %}
					</select1>
				{% elif question.answer_type == 'multiselect' %}
					<select ref="/survey/b{{batch.pk}}/q{{question.pk}}">
						<label>{{question.text}}</label>
						{% for option in question.options.all %}
						<item>
							<label>{{ option.text }}</label>
							<value>{{ option.pk }}</value>
						</item>
						{% endfor %}
					</select>
				{% elif question.answer_type == 'image' %}
					<upload ref="/survey/b{{batch.pk}}/q{{question.pk}}"   appearance="annotate" mediatype="image/*">
						<label>{{question.text}}</label>
					</upload>
				{% elif question.answer_type == 'audio' %}
					<upload ref="/survey/b{{batch.pk}}/q{{question.pk}}"   mediatype="audio/*">
						<label>{{question.text}}</label>
					</upload>
				{% elif question.answer_type == 'video' %}
					<upload ref="/survey/b{{batch.pk}}/q{{question.pk}}" mediatype="video/*">
						<label>{{question.text}}</label>
					</upload>
				{% else %}
				<input ref="/survey/b{{batch.pk}}/q{{question.pk}}">
					<label>{{question.text}}</label>
				</input>
				{% endif %}
                {% if question.group.name == 'NON_RESPONSE' %}
                <input ref="/survey/b{{batch.pk}}/qnr{{question.pk}}">
					<label>Please enter reason for no response</label>
				</input>
                {% endif %}
			{% endfor %}
		</group>
	{% endfor %}

</h:body>
</h:html>
