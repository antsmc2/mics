{% load template_tags %}
<h:html xmlns="http://www.w3.org/2002/xforms"
xmlns:h="http://www.w3.org/1999/xhtml"
xmlns:ev="http://www.w3.org/2001/xml-events"
xmlns:xsd="http://www.w3.org/2001/XMLSchema"
xmlns:jr="http://openrosa.org/javarosa">
<h:head>
<h:title> 
  {{survey.name}} 
  {% if survey.has_sampling %} for
  {{ survey.sample_size }} random households only
  {% endif %} 
</h:title>
  <model>
  <instance>
   <survey id="{{ survey.pk }}" >
     <meta>
       <instanceID />
       <instanceName />
     </meta>
     <chooseExistingHousehold>1</chooseExistingHousehold>
    <registeredHousehold>
        <household />
        <selectedMember />
        <selectedMemberName />
        <householdMember>
        {% for r_household in registered_households %}
            <h{{r_household.pk}} />
        {% endfor %}
        </householdMember>
    </registeredHousehold>
	{% for batch in survey_batches %}
		{% if interviewer.ea in batch.non_response_eas %}
	   		<bnr{{batch.pk}}>0</bnr{{batch.pk}}>
	   		<qnr{{batch.pk}} />
		{% endif %}
	   <b{{batch.pk}}>
			{% for question in batch.survey_questions %}
				<q{{question.pk}} />
			{% endfor %}
		</b{{batch.pk}}>

	{% endfor %}
   </survey>
  </instance>

  <!-- bindings -->
  <bind nodeset="/survey/meta/instanceID" type="string" 
           readonly="true()" calculate="concat('uuid:',uuid())" />
  <bind nodeset="/survey/meta/instanceName" type="string" 
           readonly="true()" calculate="concat('{{ survey.name}}', /survey/household/houseNumber, ' ', {% for r_household in registered_households %}/survey/registeredHousehold/householdMember/h{{r_household.pk}}, {% endfor %}'')" />

   {% for r_household in registered_households %}
   <bind nodeset="/survey/registeredHousehold/householdMember/h{{r_household.pk}}" type="select1"  required="true()" relevant="selected(/survey/registeredHousehold/household,'{{r_household.pk}}')" />
   {% endfor %}
  <bind nodeset="/survey/registeredHousehold/selectedMember" type="string" 
       readonly="true()" calculate="concat({% for r_household in registered_households %}/survey/registeredHousehold/householdMember/h{{r_household.pk}}, {% endfor %}'')" />

	{% for batch in survey_batches  %}
		{% for question in batch.survey_questions %}
		{% is_relevant_odk question interviewer registered_households as relevance_context %}
			<bind nodeset="/survey/b{{batch.pk}}/q{{question.pk}}"
				type="{% if question.answer_type.lower == answer_types.number %}int{% elif question.answer_type.lower == answer_types.multichoice %}select1{% elif question.answer_type.lower == answer_types.multiselect %}select{% elif question.answer_type.lower == answer_types.date %}date{% elif question.answer_type.lower == answer_types.audio or answer_type == answer_types.image or answer_type == answer_types.video %}binary{% elif question.answer_type.lower == answer_types.geopoint %}geopoint{% else %}string{% endif %}"
			relevant="{% if interviewer.ea in batch.non_response_eas %}selected(/survey/bnr{{batch.pk}}, '0'){% else %}true(){% endif %} {{ relevance_context }}"/>
        	{% if interviewer.ea in batch.non_response_eas %}
				<bind nodeset="/survey/bnr{{batch.pk}}" type="select1" />
	    		<bind nodeset="/survey/qnr{{batch.pk}}" type="string" relevant="selected(/survey/bnr{{batch.pk}}, '1')" required="selected(/survey/bnr{{batch.pk}}, '1')" />
			{% endif %}
		{% endfor %}
	{% endfor %}

  </model>
</h:head>
<h:body>
    <group>
        <label>Household details</label>
        {% if survey.has_sampling %}
            <hint>Please complete this survey for {{ survey.sample_size }} random households only</hint>
        {% endif %}
	    <select1 ref="/survey/registeredHousehold/household">
	         <label>Select Household</label>
	         {% for r_household in registered_households %}
			    <item>
	               <label>HH-{{r_household.house_number}}{% if r_household.get_head %}, {{r_household.get_head.surname}}{% endif %}</label>
	               <value>{{r_household.pk}}</value>
	            </item>                 
	         {% endfor %}
	    </select1>
	    {% for r_household in registered_households %}
	        <select1 ref="/survey/registeredHousehold/householdMember/h{{r_household.pk}}">
	            <label>Select Household Member</label>
			    {% for member in r_household.members %}
			    <item>
	               <label>{{member.surname}}, {{member.first_name}} </label>
	               <value>{{member.pk}}_{{member.surname}}_{{member.first_name}}</value>
	            </item>
			    {% endfor %}
	        </select1>
	   {% endfor %}            
    </group>
	{% for batch in survey_batches %}
		<group>
			<label>{{ batch.name }}</label>
			<hint>{{ batch.description }}</hint>
			{% if interviewer.ea in batch.non_response_eas %}
                <select1  ref="/survey/bnr{{batch.pk}}">
					<label>Member is available to respond</label>
					<item>
						<label>Yes</label>
						<value>0</value>
					</item>
					<item>
						<label>No</label>
						<value>1</value>
					</item>
				</select1>
				<input ref="/survey/qnr{{batch.pk}}">
					<label>Enter reason for non response</label>
				</input>
			{% endif %}
			{% for question in batch.survey_questions %}
				{% if question.answer_type.lower == answer_types.multichoice %}
					<select1 ref="/survey/b{{batch.pk}}/q{{question.pk}}">
						<label>{{question.text}}</label>
						{% for option in question.options.all %}
						<item>
							<label>{{ option.text }}</label>
							<value>{{ option.pk }}</value>
						</item>
						{% endfor %}
					</select1>
				{% elif question.answer_type.lower == answer_types.multiselect %}
					<select ref="/survey/b{{batch.pk}}/q{{question.pk}}">
						<label>{{question.text}}</label>
						{% for option in question.options.all %}
						<item>
							<label>{{ option.text }}</label>
							<value>{{ option.pk }}</value>
						</item>
						{% endfor %}
					</select>
				{% elif question.answer_type.lower == answer_types.image %}
					<upload ref="/survey/b{{batch.pk}}/q{{question.pk}}"   appearance="annotate" mediatype="image/*">
						<label>{{question.text}}</label>
					</upload>
				{% elif question.answer_type.lower == answer_types.audio %}
					<upload ref="/survey/b{{batch.pk}}/q{{question.pk}}"   mediatype="audio/*">
						<label>{{question.text}}</label>
					</upload>
				{% elif question.answer_type.lower == answer_types.video %}
					<upload ref="/survey/b{{batch.pk}}/q{{question.pk}}" mediatype="video/*">
						<label>{{question.text}}</label>
					</upload>
                {% elif question.answer_type.lower == answer_types.date %}
				<input ref="/survey/b{{batch.pk}}/q{{question.pk}}" appearance="no-calendar">
					<label>{{question.text}}</label>
				</input>
				{% else %}
				<input ref="/survey/b{{batch.pk}}/q{{question.pk}}">
					<label>{{question.text}}</label>
				</input>
				{% endif %}

			{% endfor %}
		</group>
	{% endfor %}

</h:body>
</h:html>
